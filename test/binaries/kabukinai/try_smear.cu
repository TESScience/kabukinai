#include "kabukinai.h"
#include <stdio.h>


const float input_pixels[] = 
{ 0.0, 0.0, 0.0, 1.0, 2.0, 0.0 ,
0.0, 0.0,12.0,13.0,14.0, 0.0 ,
0.0, 0.0,24.0,25.0,26.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 5.0, 4.0, 3.0, 0.0 ,
0.0, 0.0,17.0,16.0,15.0, 0.0 ,
0.0, 0.0,29.0,28.0,27.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 6.0, 7.0, 8.0, 0.0 ,
0.0, 0.0,18.0,19.0,20.0, 0.0 ,
0.0, 0.0,30.0,31.0,32.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0,11.0,10.0, 9.0, 0.0 ,
0.0, 0.0,23.0,22.0,21.0, 0.0 ,
0.0, 0.0,35.0,34.0,33.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 };

const float expected[] = {
0.00,0.00,0.00,1.00,2.00,0.00,
0.00,0.00,12.00,13.00,14.00,0.00,
0.00,0.00,24.00,25.00,26.00,0.00,
0.00,0.00,9.00,9.75,10.50,0.00,
0.00,0.00,9.00,9.75,10.50,0.00,
0.00,0.00,9.00,9.75,10.50,0.00,
0.00,0.00,0.00,0.00,0.00,0.00,
0.00,0.00,0.00,0.00,0.00,0.00,
0.00,0.00,5.00,4.00,3.00,0.00,
0.00,0.00,17.00,16.00,15.00,0.00,
0.00,0.00,29.00,28.00,27.00,0.00,
0.00,0.00,12.75,12.00,11.25,0.00,
0.00,0.00,12.75,12.00,11.25,0.00,
0.00,0.00,12.75,12.00,11.25,0.00,
0.00,0.00,0.00,0.00,0.00,0.00,
0.00,0.00,0.00,0.00,0.00,0.00,
0.00,0.00,6.00,7.00,8.00,0.00,
0.00,0.00,18.00,19.00,20.00,0.00,
0.00,0.00,30.00,31.00,32.00,0.00,
0.00,0.00,13.50,14.25,15.00,0.00,
0.00,0.00,13.50,14.25,15.00,0.00,
0.00,0.00,13.50,14.25,15.00,0.00,
0.00,0.00,0.00,0.00,0.00,0.00,
0.00,0.00,0.00,0.00,0.00,0.00,
0.00,0.00,11.00,10.00,9.00,0.00,
0.00,0.00,23.00,22.00,21.00,0.00,
0.00,0.00,35.00,34.00,33.00,0.00,
0.00,0.00,17.25,16.50,15.75,0.00,
0.00,0.00,17.25,16.50,15.75,0.00,
0.00,0.00,17.25,16.50,15.75,0.00,
0.00,0.00,0.00,0.00,0.00,0.00,
0.00,0.00,0.00,0.00,0.00,0.00};


int main() {
	simulation_data d;
	float image_pixels[4*8*6];	// enough to hold sliced image
	
	
	PANIC_ON_BAD_CUDA_STATUS(cudaMalloc((void **) &d.image_pixels, 4*8*6*sizeof(float)));
	PANIC_ON_BAD_CUDA_STATUS(cudaMemcpy(d.image_pixels, input_pixels,
		4*8*6*sizeof(float),cudaMemcpyHostToDevice));
	d.dimensions[0] = 3;
	d.dimensions[1] = 12;
	d.number_of_slices = 4;
	d.early_dark_pixels = 2;
	d.late_dark_pixels = 1;
	d.smear_rows = 3;
	d.final_dark_rows = 2;
	d.smear_ratio = 0.25;		// chosen for exact results for test
	
	printf( "Calling add_smear: " );
	add_smear( &d );
	printf( "success!\n" );
	
	
	PANIC_ON_BAD_CUDA_STATUS(cudaMemcpy(image_pixels, d.image_pixels,
		4*8*6*sizeof(float),cudaMemcpyDeviceToHost));
	
	int result = KABUKINAI_SUCCESS;

	for( int i = 0; i < 4*8*6; i+=1 ) {
		if( image_pixels[i] != expected[i] ) {
			printf( "At pixel %d expected %f got %f\n", i, expected[i], image_pixels[i] );
			result = KABUKINAI_FAILURE;
		}
	}
	
	return result;
}

#include "kabukinai.h"
#include <stdio.h>


const float input_pixels[] = 
{ 0.0, 0.0, 0.0, 1.0, 2.0, 0.0 ,
0.0, 0.0,12.0,13.0,14.0, 0.0 ,
0.0, 0.0,24.0,25.0,26.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 5.0, 4.0, 3.0, 0.0 ,
0.0, 0.0,17.0,16.0,15.0, 0.0 ,
0.0, 0.0,29.0,28.0,27.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 6.0, 7.0, 8.0, 0.0 ,
0.0, 0.0,18.0,19.0,20.0, 0.0 ,
0.0, 0.0,30.0,31.0,32.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0,11.0,10.0, 9.0, 0.0 ,
0.0, 0.0,23.0,22.0,21.0, 0.0 ,
0.0, 0.0,35.0,34.0,33.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 ,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0 };

const float expected[] = {
0.000000,0.000000,0.000000,2.000000,4.000000,0.000000,
0.000000,0.000000,24.000000,26.000000,28.000000,0.000000,
0.000000,0.000000,48.000000,50.000000,52.000000,0.000000,
0.000000,0.000000,18.000000,19.500000,21.000000,0.000000,
0.000000,0.000000,18.000000,19.500000,21.000000,0.000000,
0.000000,0.000000,18.000000,19.500000,21.000000,0.000000,
0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
0.000000,0.000000,10.000000,8.000000,6.000000,0.000000,
0.000000,0.000000,34.000000,32.000000,30.000000,0.000000,
0.000000,0.000000,58.000000,56.000000,54.000000,0.000000,
0.000000,0.000000,25.500000,24.000000,22.500000,0.000000,
0.000000,0.000000,25.500000,24.000000,22.500000,0.000000,
0.000000,0.000000,25.500000,24.000000,22.500000,0.000000,
0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
0.000000,0.000000,12.000000,14.000000,16.000000,0.000000,
0.000000,0.000000,36.000000,38.000000,40.000000,0.000000,
0.000000,0.000000,60.000000,62.000000,64.000000,0.000000,
0.000000,0.000000,27.000000,28.500000,30.000000,0.000000,
0.000000,0.000000,27.000000,28.500000,30.000000,0.000000,
0.000000,0.000000,27.000000,28.500000,30.000000,0.000000,
0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
0.000000,0.000000,22.000000,20.000000,18.000000,0.000000,
0.000000,0.000000,46.000000,44.000000,42.000000,0.000000,
0.000000,0.000000,70.000000,68.000000,66.000000,0.000000,
0.000000,0.000000,34.500000,33.000000,31.500000,0.000000,
0.000000,0.000000,34.500000,33.000000,31.500000,0.000000,
0.000000,0.000000,34.500000,33.000000,31.500000,0.000000,
0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
0.000000,0.000000,0.000000,0.000000,0.000000,0.000000
};


int main() {
	simulation_data d;
	float image_pixels[4*8*6];	// enough to hold sliced image
	
	
	PANIC_ON_BAD_CUDA_STATUS(cudaMalloc((void **) &d.image_pixels, 4*8*6*sizeof(float)));
	PANIC_ON_BAD_CUDA_STATUS(cudaMemcpy(d.image_pixels, input_pixels,
		4*8*6*sizeof(float),cudaMemcpyHostToDevice));
	d.dimensions[0] = 3;
	d.dimensions[1] = 12;
	d.number_of_slices = 4;
	d.early_dark_pixels = 2;
	d.late_dark_pixels = 1;
	d.smear_rows = 3;
	d.final_dark_rows = 2;
	d.smear_ratio = 0.25;		// chosen for exact results for test
	d.exposure_time = 2.0;
	
	printf( "Calling expose_and_smear: " );
	expose_and_smear( &d );
	printf( "success!\n" );
	
	
	PANIC_ON_BAD_CUDA_STATUS(cudaMemcpy(image_pixels, d.image_pixels,
		4*8*6*sizeof(float),cudaMemcpyDeviceToHost));
	
	int result = KABUKINAI_SUCCESS;

	for( int i = 0; i < 4*8*6; i+=1 ) {
		if( image_pixels[i] != expected[i] ) {
			printf( "At pixel %d expected %f got %f\n", i, expected[i], image_pixels[i] );
			result = KABUKINAI_FAILURE;
		}
	}

	return result;
}
